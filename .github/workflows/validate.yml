name: PR Validation & Review

on:
  pull_request:
    paths:
      - 'thevector/content/**/*.md'
      - '.wordlist.txt'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  spellcheck:
    runs-on: ubuntu-latest
    name: German Spell & Grammar Check
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed markdown files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only --diff-filter=d \
              ${{ github.event.pull_request.base.sha }} \
              ${{ github.event.pull_request.head.sha }} \
              -- 'thevector/content/**/*.md' || echo "")
          else
            FILES=$(find thevector/content -name '*.md' -type f)
          fi
          
          if [ -z "$FILES" ]; then
            echo "No markdown files changed"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Spellcheck
        if: steps.changed-files.outputs.files != ''
        uses: rojopolis/spellcheck-github-actions@0.55.0
        with:
          config_path: .spellcheck.yml
          task_name: Markdown
        continue-on-error: true

      - name: Create PR comments for spelling errors
        if: always() && steps.changed-files.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Versuche, die spellcheck Ausgabe zu lesen
            // Die Action speichert Details in einer Ausgabedatei
            try {
              // GitHub Actions speichert Logs - wir parsen sie
              const logs = `${{ toJSON(job) }}`;
              
              // Alternative: Prüfe auf Fehler in der Workflow-Ausgabe
              console.log('Spellcheck abgeschlossen. PR-Kommentare können manuell hinzugefügt werden.');
              
            } catch (error) {
              console.log('Fehler beim Parsen:', error);
            }

      - name: Annotate errors in PR
        if: always()
        run: |
          echo "✅ Spellcheck für deutsche Markdown-Dateien abgeschlossen"
          echo "Hinweis: Bei Rechtschreibfehlern in .log-Datei nachprüfen"


  # check-files:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     markdown: ${{ steps.filter.outputs.markdown }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dorny/paths-filter@v2
  #       id: filter
  #       with:
  #         filters: |
  #           markdown:
  #             - 'thevector/content/**/*.md'

  # spellcheck:
  #   runs-on: ubuntu-latest
  #   needs: check-files
  #   if: needs.check-files.outputs.markdown == 'true' || github.event_name == 'workflow_dispatch'
  #   name: German Spell & Grammar Check
    
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Check Spelling (German)
  #       uses: rojopolis/spellcheck-github-actions@0.55.0
  #       with:
  #         config_path: .spellcheck.yml
  #         task_name: Markdown
          
  # content-validation:
  #   runs-on: ubuntu-latest
  #   needs: check-files
  #   if: needs.check-files.outputs.markdown == 'true' || github.event_name == 'workflow_dispatch'
  #   name: Content Validation
    
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Check frontmatter
  #       run: |
  #         for file in ./thevector/content/**/*.md; do
  #           if [ -f "$file" ]; then
  #             for field in title date description image; do
  #               if ! grep -q "^${field}:" "$file"; then
  #                 echo "❌ $file: Missing '$field'"
  #                 exit 1
  #               fi
  #             done
  #           fi
  #         done
