name: PR Validation & Review

on:
  pull_request:
    paths:
      - 'thevector/content/**/*.md'
      - '.wordlist.txt'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  spellcheck:
    runs-on: ubuntu-latest
    name: German Spell & Grammar Check
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed markdown files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only --diff-filter=d \
              ${{ github.event.pull_request.base.sha }} \
              ${{ github.event.pull_request.head.sha }} \
              -- 'thevector/content/**/*.md' || echo "")
          else
            FILES=$(find thevector/content -name '*.md' -type f)
          fi
          
          if [ -z "$FILES" ]; then
            echo "No markdown files changed"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Spellcheck
        if: steps.changed-files.outputs.files != ''
        uses: rojopolis/spellcheck-github-actions@0.55.0
        with:
          config_path: .spellcheck.yml
          task_name: Markdown
        continue-on-error: true

      - name: Create PR comments for spelling errors
        if: always() && steps.changed-files.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Versuche, die spellcheck Ausgabe zu lesen
            // Die Action speichert Details in einer Ausgabedatei
            try {
              // GitHub Actions speichert Logs - wir parsen sie
              const logs = `${{ toJSON(job) }}`;
              
              // Alternative: Pr√ºfe auf Fehler in der Workflow-Ausgabe
              console.log('Spellcheck abgeschlossen. PR-Kommentare k√∂nnen manuell hinzugef√ºgt werden.');
              
            } catch (error) {
              console.log('Fehler beim Parsen:', error);
            }

      - name: Annotate errors in PR
        if: always()
        run: |
          echo "‚úÖ Spellcheck f√ºr deutsche Markdown-Dateien abgeschlossen"
          echo "Hinweis: Bei Rechtschreibfehlern in .log-Datei nachpr√ºfen"
      
            - name: Install dependencies
        if: steps.changed-files.outputs.files != ''
        run: |
          pip install pyspelling aspell-python-py3

      - name: Run spellcheck with detailed output
        if: steps.changed-files.outputs.files != ''
        id: spelling
        run: |
          python -m pyspelling -c .spellcheck.yml > spellcheck_output.txt 2>&1 || true
          cat spellcheck_output.txt

      - name: Parse and comment errors
        if: always() && steps.changed-files.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const output = fs.readFileSync('spellcheck_output.txt', 'utf8');
              
              if (output.includes('Misspelled words')) {
                // Parse Fehler aus Output
                const lines = output.split('\n');
                let errorComment = 'üîç **Rechtschreibfehler gefunden:**\n\n';
                
                lines.forEach(line => {
                  if (line.match(/\w+ \(\d+\)/)) {
                    errorComment += `- ‚ùå ${line}\n`;
                  }
                });
                
                errorComment += '\n**üí° Tipp:** Korrekte W√∂rter k√∂nnen zur Whitelist (`.wordlist.txt`) hinzugef√ºgt werden.';
                
                // Erstelle PR-Kommentar
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: errorComment
                });
              }
            } catch (error) {
              console.log('Fehler beim Parsen:', error);
            }



  # check-files:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     markdown: ${{ steps.filter.outputs.markdown }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dorny/paths-filter@v2
  #       id: filter
  #       with:
  #         filters: |
  #           markdown:
  #             - 'thevector/content/**/*.md'

  # spellcheck:
  #   runs-on: ubuntu-latest
  #   needs: check-files
  #   if: needs.check-files.outputs.markdown == 'true' || github.event_name == 'workflow_dispatch'
  #   name: German Spell & Grammar Check
    
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Check Spelling (German)
  #       uses: rojopolis/spellcheck-github-actions@0.55.0
  #       with:
  #         config_path: .spellcheck.yml
  #         task_name: Markdown
          
  # content-validation:
  #   runs-on: ubuntu-latest
  #   needs: check-files
  #   if: needs.check-files.outputs.markdown == 'true' || github.event_name == 'workflow_dispatch'
  #   name: Content Validation
    
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Check frontmatter
  #       run: |
  #         for file in ./thevector/content/**/*.md; do
  #           if [ -f "$file" ]; then
  #             for field in title date description image; do
  #               if ! grep -q "^${field}:" "$file"; then
  #                 echo "‚ùå $file: Missing '$field'"
  #                 exit 1
  #               fi
  #             done
  #           fi
  #         done
